<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width">

        <link rel="stylesheet" href="css/bootstrap.css">
        <!--[if lt IE 9]>
        <script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
        <![endif]-->
        <script src="../bower_components/angular/angular.js"></script>
        <script src="../bower_components/elastic.js/dist/elastic.js"></script>
        <script src="../bower_components/elastic.js/dist/elastic-angular-client.js"></script>
        <script src="js/ng-table.js"></script>
        <script src="js/regions.js"></script>
        <script src="js/categories.js"></script>
        <script src="../src/scripts/02-app.js"></script>
        <script src="../src/scripts/03-bzModel.js"></script>
    </head>
<body ng-app="main">
<h1>Table with pagination</h1>

<div ng-controller="DemoCtrl">

    <div class="row">
        <div class="col col-xs-6">
            <select class="form-control" multiple size="10" ng-model="filter.region_id" ng-options="value.id as value.title for value in regions"></select>
        </div>
        <div class="col col-xs-6">
            <select class="form-control" multiple size="10" ng-model="filter.category_id" ng-options="key as value.title group by value.group.title for (key, value) in categories"></select>
        </div>
    </div>

    <table class="table" ng-table="tableParams">
    <tr ng-repeat="item in $data">
        <td data-title="'Title'">{{item.title}}</td>
        <td data-title="'Category'">{{item.getCategory().title}}</td>
        <td>{{item.createdAt()}}</td>
    </tr>
    <table>

        <script>
        var app = angular.module('main', ['bzModel', 'ngTable', 'news.categories', 'news.regions']).
        config(function(bzModelProvider) {
            bzModelProvider.url('http://news.mistinfo.com')
                           .index('news.mistinfo.com');
        }).
        run(function($rootScope, newsCategories, newsRegions) {
            var categories = {};

            angular.forEach(newsCategories, function(value) {
                if (!value.categories) {
                    categories[parseInt(value.id)] = value;
                } else {
                    angular.forEach(value.categories, function(item) {
                        item.group = value;
                        categories[parseInt(item.id)] = item;
                    });
                }
            });

            $rootScope.categories = categories;
            $rootScope.regions = newsRegions;
        }).
        factory('NewsItem', function(bzModel, $filter, $rootScope) {
            var dateFilter = $filter('date');
            
            return new bzModel({
                $name: 'com_news_news',
                $defaults: {
                    id: 1,
                    title: 'Untitled',
                    estimate: ''
                },
                $initialize: function() {
                    this.one = 1;
                },
                getId: function() {
                    return this.id;
                },
                getCategory: function() {
                    return $rootScope.categories[parseInt(this.category_id)];
                },
                createdAt: function(format) {
                    this._createdAt = this._createdAt || dateFilter(this.created_at, format || 'medium');
                    return this._createdAt;
                }
            });
        }).
        controller('DemoCtrl', function($scope, NewsItem, ngTableParams, newsCategories) {
            var model = new NewsItem();

            $scope.newsCategories = newsCategories;

            $scope.tableParams = new ngTableParams({
                page: 1,
                count: 10
            }, {
                getData: function($defer, params) {
                
                    model.$search($scope.filter)
                         .$execute({
                                page: params.page(),
                                count: params.count(),
                                sorting: {
                                    'top_expiration_date': 'desc'
                                }
                            }).$promise.then(function(res) {
                                params.total(res.$total);

                                $defer.resolve(res);
                            });
                }
            });
            
            $scope.$watch('filter', function() {
                $scope.tableParams.reload();
            }, true);
        })
        </script>

</div>


    </body>
</html>